AppWheel SDK Integration Document - iOS
Introduction
- • This is the iOS component of cross-platform subscriptions, abstracting the complete flow of implementation on iOS using StoreKit, supporting the following features:
- Obtain product information from App Store Connect
-  Purchase/Subscribe
-  Restore Purchase/Subscribe
-  Refresh Receipt Information
-  Get subscription discount signature
-  ROI Data Collection
Instructions for Use
Integration Requirements
- iOS 10.0 and above
Integration
- • The integration should be done with CocoaPods and the following orders should be added to Podfile.
pod 'AppWheel'

The latest version can be obtained through the official website or by executing :pod search AppWheel.
All methods support Swift calls. Please add the following sentences to the Bridging-Header file.
import <PurchaseSDK/InAppPurchaseKit.h>

Code Application
- ！！！This component takes InAppPurchaseKit as the core class, in which all interfaces are included. You can call the class method as needed. 
Initial Configuration
(void)configureWithAppId:(NSInteger)appId
                     uid:(NSString * _Nullable)appUserId
              completion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion; 

InAppPurchaseKit.configure(withAppId: Int,
                             uid: String?) 
                             { (Bool, InAppPurchaseError) in
                                }

It should be used in AppDelegate’s didFinishLaunchingWithOptions: as soon as possible.
Parameters:
1. appId: Generated by the subscription cross-platform's server
2. uid: userId, no empty string for transferring
3. completion: Initialization result's block. Returns 'true' if initialization is successful; returns 'false' if not. This component cannot be used in the case of configuration failure. 
！ ！ ！ This component cannot be used in the case of configuration failure. 
Get Products
+ (void)getProductsInfoWithProductIdentifiers:(NSSet<NSString *> *)productIdentifiers                                      completion:(void (^)(RetrievedProducts * retrievedProducts))completion;

InAppPurchaseKit.getProductsInfo(withProductIdentifiers: Set<String>)
                                 { (RetrievedProducts) in
                                      }

The method used to get the product interface we provide is essentially the same as StoreKit's. The RetrievedProducts structure contains an obtained product array, an SKU array of products that were not obtained, and objectives of InAppPurchaseError. 
Please see documentation in Lark for detailed product data structure.
Purchase/Subscribe
-  Purchases (consumable and non-consumable)
+ (void)purchaseProductWithProductIdentifier:(NSString *)productIdentifier
                              paymentDiscount:(PaymentDiscountOffer * _Nullable)paymentDiscount                                     
                              quantity:(NSInteger)quantity
                              productType:(NSInteger)productType                                   
                              completion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion;

InAppPurchaseKit.purchaseProduct(Product, 
                                paymentDiscount: PaymentDiscountOffer?, 
                                quantity: Int, 
                                productType: Int) 
                                { (Bool, InAppPurchaseError) in
                                      }

参数：
1. Parameters:
2.  productIdentifier: Product SKU
3.  paymentDiscount: Discounts. Only for subscription products and can be acquired through Product.discounts. No transferable nil. 
4.  quantity: Quantity of purchases. The number of non-consumable products is usually 1. 
5. productType: Type of products. There are usually four types: 0(consumable),1( non-consumable), 2(auto-renewable) and 3(non-renewable). Users can tell the type according to the SKU.
- Subscription Products
1.Obtain Signature of Subscription Offers
+ (void)fetchSubscriptionOfferWithProductIdentifier:(NSString *)productIdentifier
                         subscriptionOfferIdentifier:(NSString *)subscriptionOfferIdentifier
                                          completion:(void (^)(PaymentDiscountOffer * _Nullable paymentDiscount, InAppPurchaseError * error))completion;

InAppPurchaseKit.fetchSubscriptionOffer(withProductIdentifier: String, 
                                    subscriptionOfferIdentifier: String) 
                                    { (PaymentDiscountOffer?, InAppPurchaseError) in }

Parameters:
1. productIdentifier: Product SKU
2. subscriptionOfferIdentifier: Discount ID of Subscription Offer 
- Subscription
+ (void)purchaseProductWithProductIdentifier:(NSString *)productIdentifier
                              paymentDiscount:(PaymentDiscountOffer * _Nullable)paymentDiscount
                                     quantity:(NSInteger)quantity
                                  productType:(NSInteger)productType 
                                   completion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion;   + (void)purchaseProduct:(Product *)product         paymentDiscount:(PaymentDiscountOffer * _Nullable)paymentDiscount                quantity:(NSInteger)quantity             productType:(NSString *)productType              completion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion;

InAppPurchaseKit.purchaseProduct(withProductIdentifier: String, 
                                    quantity: Int,
                                     productType: Int) 
                                     { (Bool, InAppPurchaseError) in}

Parameters:
1. productIdentifier: Product SKU
2. paymentDiscount: Discounts. Only for subscription products and can be acquired through Product.discounts. No transferable nil. 
3. quantity: Quantity of purchases. The number of subscription products is usually 1. 
4. productType:  Type of products. There are usually four types: 0(consumable),1( non-consumable), 2(auto-renewable) and 3(non-renewable). Users can tell the type according to the SKU.
Restore Purchase 
+ (void)restorePurchaseWithCompletion:(nullable void (^)(BOOL success, NSArray * validSubscriptions, NSArray * restoredPurchasedItems, InAppPurchaseError * restoredSubscriptionResult))completion;

InAppPurchaseKit.restorePurchase { (success, validSubscriptions, productIds, error) in}

Parameters in this blocking method: success refers to if the restoration succeeds; validSubscriptions refers to the receipt information of all the valid orders; restoredPurchasedItemsrefers to the single SKU restored; restoredSubscriptionResult refers to an InAppPurchaseError instance.
Refresh Receipt Information
+ (void)refreshInAppPurchaseInfoWithCompletion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion;

InAppPurchaseKit.refreshInAppPurchaseInfo { (Bool, InAppPurchaseError) in }

Sends the receipts in the sandbox to the backend, which verifies the receipts with Apple to get the latest receipt information and returns it to the client. Use it when you don't need to have any transactions with StoreKit but need to get the latest information about user subscriptions, such as checking if the user is in the grace period, migrating old versions of data, etc.
Get Detailed Single Item Purchase Information
Obtain InAppPurchaseInfo：[InAppPurchaseKit getPurchaseInfo]
InAppPurchaseInfo productUnlocked:(NSString *)productIdentifier;  
InAppPurchaseInfo productQuantity:(NSString *)productIdentifier;  
InAppPurchaseInfo purchasedIds;
InAppPurchaseInfo purchasedArray

InAppPurchaseInfo.productUnlocked(productId)
InAppPurchaseInfo. productQuantity(productId)
InAppPurchaseInfo. purchasedIds()
InAppPurchaseInfo. purchasedArray()

Transfer product SKU to productUnlocked: and the result of a user's purchase state of the product will be returned. 
Transfer product SKU to productQuantity: and the quantity of the product (only consumable products) purchased by a user will be returned. 
The purchasedIds' method is an NSString array that contains all currently valid single item purchases and non-renewable SKU subscriptions. 
The purchasedArray's method is a PurchasedProduct array that contains all currently valid single item purchases and non-renewable product subscriptions. 
Get Detailed Subscription Information
To tell if a user has initiated a subscription (if the subscription is valid or still in the grace period).
InAppPurchaseInfo isSubscriptionUnlockedUser;

InAppPurchaseInfo.isSubscriptionUnlockedUser()

To tell if a user is in the grace period 
InAppPurchaseInfo userInGracePeriod;

InAppPurchaseInfo. userInGracePeriod()

To know the date of a user's first subscription.
InAppPurchaseInfo originalTransactionDate;

InAppPurchaseInfo. originalTransactionDate()

To know the expiration date of a user's current subscription (grace period not counted).
InAppPurchaseInfo currentSubscriptionExpiredDate;

InAppPurchaseInfo. currentSubscriptionExpiredDate()

To know the expiration date of a user's current grace period
InAppPurchaseInfo currentGracePeriodExpiredDate;

InAppPurchaseInfo. currentGracePeriodExpiredDate()

To get the receipt information of a user's latest subscription
Please see document in Lark for detailed product data structure.
InAppPurchaseInfo getLatestSubscriptionInfo;

InAppPurchaseInfo. getLatestSubscriptionInfo()

To Add/Delete Observer
The observer will be notified when the subscription state changes or when the single purchase information maintained within the component changes. The observer should follow the InAppPurchaseObserver agreement as follows:：
@protocol InAppPurchaseObserver <NSObject> 
- (void)purchases:(InAppPurchaseInfo *) purchaseInfo;  
@end

Add or delete an observer through the method provided by InAppPurchaseKit class. 
InAppPurchaseKit addPurchaseObserver:(id<InAppPurchaseObserver>)observer;
InAppPurchaseKit removePurchaseObserver:(id<InAppPurchaseObserver>)observer;

InAppPurchaseKit.add(observer: InAppPurchaseObserver)
InAppPurchaseKit.remove(observer: InAppPurchaseObserver)

Manually Refresh A User's Subscription Status
For a better user experience and to avoid frequent reads and writes, after the subscription expires, the component will refresh the user's subscription status at the next start, instead of locking the subscription directly when it expires. If you need to determine precisely whether a user's subscription has expired in this Session, you can call the following method.
InAppPurchaseInfo refreshInAppPurchaseState;

InAppPurchaseInfo. refreshInAppPurchaseState()

Determine the expiration date after refreshing the subscription status. 
App Store Promotion
Set Callback for App Store Promotion
InAppPurchaseKit setShouldAddStorePaymentBlock:(void (^)(Product * product, SKPayment * payment))completion;

InAppPurchaseKit.setShouldAddStorePaymentBlock { (Product, SKPayment) in }

Please set this callback after the initialization of the component, which will be triggered after a user taps on the App Store promotion and starts the app. The product parameter refers to the App Store's promotional product information. The payment parameter refers to the payment created in the App Store. Please do not change the parameters. 
Subscribe to App Store Promotional Products
InAppPurchaseKit subscribeProductFromAppStorePromotion:(Product *)product 
                                               payment:(SKPayment *)skPayment 
                                             productType:(NSInteger)productType
                                            completion:(nullable void (^)(BOOL success, InAppPurchaseError * error))completion;

InAppPurchaseKit.subscribeProduct(fromAppStorePromotion: Product,
                                     payment: SKPayment, 
                                     productType: Int) 
                                     { (Bool, InAppPurchaseError) in
                                          }

Please use this interface for subscribing to promotional products. Achieve it by transferring ShouldAddStorePaymentBlock callback parameters to product and payment parameters. 
productType: Please refer to the types in purchase and subscription. 
App Store Refund
！ ！ ！ The following interfaces are only available in Xcode 12 and above.
InAppPurchaseKit setRevokeEntitlementsBlock:(void (^)(NSArray<NSString *> * productIdentifiers))completion;

InAppPurchaseKit.setRevokeEntitlementsBlock { ([productIdentifiers]) in
      }

When a user successfully refunds/exits Family Share, the SDK will automatically verify the receipt and clear the corresponding purchased/subscription products and call the callback of the method when the verification is completed. The productIdentifiers refers to the SKU of this refund and can be used to set UI information. 
Subscribe Multiple Products
！ ！ ！ The following interface supports the condition when multiple subscription items exist in the application, and can be ignored if only one active subscription exists within the application.
A valid subscription as described in the following interface means that the subscription has not reached its expiration time or grace period expiration time.
Obtain all valid subscription information in the app
InAppPurchaseInfo getCurrentValidSubscriptions;
The method returns all receipt information of subscriptions in the app that have not expired.
Obtain all subscription information in the app
InAppPurchaseInfo getAllSubscriptions;
This method returns receipt information of all subscriptions (valid and expired) in the app.
Manually refresh all valid subscription information
For a better user experience and to avoid frequent reads and writes, after the subscription expires, the component will refresh the user's subscription status at the next start, instead of locking the subscription directly when it expires. If you need to determine whether a subscription has expired in this Session, you can call the following method.
InAppPurchaseKit refreshValidSubscriptions;
Determine after refreshing the valid subscription information array.
Check if the subscription is currently valid
Call when you need to know if a subscription has been made.
InAppPurchaseInfo isSubscriptionValid:(NSString *)productIdentifier;
Transfer a specific product ID to the method and the subscription status of the product will be returned. 
Error Code

    InAppPurchaseErrorTypeUnknown = 0,
    
    InAppPurchaseErrorTypeClientInvalid = 1,
    InAppPurchaseErrorTypePaymentCancelled = 2,
    InAppPurchaseErrorTypePaymentInvalid = 3,
    InAppPurchaseErrorTypePaymentNotAllowed = 4,
    InAppPurchaseErrorTypeStoreProductNotAvailable = 5,
    
    InAppPurchaseErrorTypeInvalidOfferIdentifier = 11,
    InAppPurchaseErrorTypeInvalidOfferPrice = 12,
    InAppPurchaseErrorTypeInvalidSignature = 13,
    InAppPurchaseErrorTypeMissingOfferParams = 14,
    
    InAppPurchaseErrorTypeAPISecretError = 10000,
    InAppPurchaseErrorTypeAPICertError = 10001,
    InAppPurchaseErrorTypeClientParamError = 10002,
    InAppPurchaseErrorTypeSqlExecuteError = 10100,
    InAppPurchaseErrorTypeDBDataError = 10101,
    InAppPurchaseErrorTypeRedisConnectError = 10200,
    
    InAppPurchaseErrorTypeAppStoreConnectError = 20000,
    
    InAppPurchaseErrorTypeSubOfferSubscriptionError = 20001,
    InAppPurchaseErrorTypeSubOfferSubscriptionExpired = 20002,
    InAppPurchaseErrorTypeSubOfferCancelSubInfoError = 20003,
    InAppPurchaseErrorTypeSubOfferParamsEmpty = 20004,
    InAppPurchaseErrorTypeSubOfferGenerateSignatureError = 20005,
    
    InAppPurchaseErrorTypeNoReceiptDataOnDevice = 30000,
    InAppPurchaseErrorTypeInvalidRawData = 30001,
    InAppPurchaseErrorTypeNothingToDecrypt = 30002,
    InAppPurchaseErrorTypeFailedToDecrypt = 30003,
    InAppPurchaseErrorTypeDataDecryptedNotInJSON = 30004,
    InAppPurchaseErrorTypeNoItemInReceipt = 30005,
    InAppPurchaseErrorTypeNoSubscriptionInReceipt = 30006,
    InAppPurchaseErrorTypeSubscriptionExpiredInReceipt = 30007,
    InAppPurchaseErrorTypePurchaseItemError = 30008,
    
    InAppPurchaseErrorTypeInvalidProductIdentifier = 30009,
    ///Product Type Error
    InAppPurchaseErrorTypeInvalidProductType = 30010,
    /// /Initialization Error
    InAppPurchaseErrorTypeInit = 30011,
    /// Unknown Error (Network connection and more)
    InAppPurchaseErrorTypeUnknow = 30012,
    /// Error in Parsing get_ios_retry_period Interface 
    InAppPurchaseErrorTypeRetryPeriod = 30013,

